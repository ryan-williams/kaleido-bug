name: Test kaleido axref bug

on:
  workflow_dispatch:

jobs:
  test-combinations:
    name: Test plotly ${{ matrix.plotly }} + kaleido ${{ matrix.kaleido }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # This should work - plotly 5.x with kaleido 0.2.1
          - plotly: "5.24.1"
            kaleido: "0.2.1"
            expected: "pass"

          # This should fail - plotly 6.x with kaleido 0.2.1
          - plotly: "6.3.1"
            kaleido: "0.2.1"
            expected: "fail"

          # This should fail - plotly 6.x with kaleido 1.x (latest)
          - plotly: "6.3.1"
            kaleido: ">=1.0.0"
            kaleido_display: "1.x"
            expected: "fail"

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas plotly==${{ matrix.plotly }} kaleido${{ matrix.kaleido }}

      - name: Show versions
        run: |
          python -c "import plotly; print(f'plotly: {plotly.__version__}')"
          python -c "import kaleido; print(f'kaleido: {getattr(kaleido, \"__version__\", \"unknown\")}')" || echo "kaleido version unknown"

      - name: Run test
        id: test
        continue-on-error: true
        run: |
          mkdir -p tmp
          python kaleido_axref_repro.py

      - name: Check result matches expectation
        run: |
          if [ "${{ steps.test.outcome }}" = "success" ] && [ "${{ matrix.expected }}" = "pass" ]; then
            echo "✅ Test passed as expected"
            exit 0
          elif [ "${{ steps.test.outcome }}" = "failure" ] && [ "${{ matrix.expected }}" = "fail" ]; then
            echo "✅ Test failed as expected (demonstrating the bug)"
            exit 0
          else
            echo "❌ Unexpected result: got ${{ steps.test.outcome }}, expected ${{ matrix.expected }}"
            exit 1
          fi

      - name: Upload output images
        if: steps.test.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: output-plotly-${{ matrix.plotly }}-kaleido-${{ matrix.kaleido_display || matrix.kaleido }}
          path: tmp/*.png
          if-no-files-found: ignore

  test-patched:
    name: Test plotly 6.3.1 + patched kaleido (should pass)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas plotly==6.3.1

      - name: Install patched kaleido from fork
        run: |
          pip install git+https://github.com/ryan-williams/Kaleido.git@axref-fix#subdirectory=src/py

      - name: Show versions
        run: |
          python -c "import plotly; print(f'plotly: {plotly.__version__}')"
          python -c "import kaleido; print(f'kaleido: {getattr(kaleido, \"__version__\", \"unknown\")}')"

      - name: Run test (should pass with patched kaleido)
        run: |
          mkdir -p tmp
          python kaleido_axref_repro.py

      - name: Upload output image
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: output-plotly-6.3.1-kaleido-patched
          path: tmp/*.png

  results:
    name: Results
    runs-on: ubuntu-latest
    needs: [test-combinations, test-patched]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow demonstrates the kaleido axref bug:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ plotly 5.24.1 + kaleido 0.2.1: Works" >> $GITHUB_STEP_SUMMARY
          echo "- ❌ plotly 6.3.1 + kaleido 0.2.1: Fails with 'Cannot read properties of undefined (reading val)'" >> $GITHUB_STEP_SUMMARY
          echo "- ❌ plotly 6.3.1 + kaleido 1.x: Fails with same error" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ plotly 6.3.1 + [**patched kaleido**](https://github.com/ryan-williams/Kaleido/tree/axref-fix): **Works!** (fix verified)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The issue is that plotly 6.x changed figure serialization, breaking axref='x' annotations with kaleido." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### The fix works! 🎉" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Install patched version from [ryan-williams/Kaleido@axref-fix](https://github.com/ryan-williams/Kaleido/tree/axref-fix):" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "pip install git+https://github.com/ryan-williams/Kaleido.git@axref-fix#subdirectory=src/py" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
